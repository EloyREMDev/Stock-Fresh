import{c as n}from"./notificiation.DyHDLNjw.js";import{B as u}from"./endpoints.QH1VciTq.js";import{k as d}from"./index.B9b1t7QR.js";import{a as y}from"./index.CViUNx8d.js";const m=`${u}/api/formula`;let E=[];const s=y(E),f=async o=>{if(console.log(o),o.response){const e=await o.response.json();n({title:"Ups! Hubo un error",description:e.error,type:"error"})}else n({title:"Ups! Hubo un error",description:"No se pudo conectar con el servidor. Por favor, revisa tu conexión.",type:"error"})},b=async o=>{try{const e=await d.post(m,{json:o,credentials:"include"}).json();s.set(s.get().concat(e)),n({title:"Formula creada!",type:"success"})}catch(e){if(e.name==="HTTPError"&&e.response.status>=400){const t=await e.response.json();n({title:"Ups! Hubo un error",description:t.error,type:"error"})}else n({title:"Formula creada!",description:"La formula se creó con éxito, pero la conexión se perdió. Recarga la página para verlo.",type:"success"}),console.log("Error de conexión inesperado, pero el insumo se creó con éxito:",e)}},h=async o=>{const e=`${m}/${o}`;try{const t=await d.delete(e,{credentials:"include"}).json();s.set(s.get().filter(a=>a.id!==t.id)),n({title:"Formula eliminada",description:`${t.name}`,type:"success"})}catch(t){f(t)}},x=async()=>{try{const e=(await d.get(m,{credentials:"include"}).json()).map(t=>({...t}));s.set(e)}catch(o){o.response&&(o.response.status===401||o.response.status===403)&&location.replace("/login"),f(o)}},w={addFormula:b,removeFormula:h,getFormula:x},c=document.getElementById("product-select"),i=document.getElementById("insumo-select-0"),I=document.getElementById("add-insumo-btn"),F=document.getElementById("insumos-container"),p=document.getElementById("formula-form"),$=()=>{fetch(`${u}/api/products`).then(o=>{if(!o.ok)throw new Error("Error al obtener los productos");return o.json()}).then(o=>{c.innerHTML='<option value="">Selecciona un producto</option>',o.forEach(e=>{const t=document.createElement("option");t.value=e.id,t.textContent=e.name,c.appendChild(t)})}).catch(o=>{console.error("Error al cargar los productos:",o),c.innerHTML='<option value="">Error al cargar los productos</option>'})},B=()=>{fetch(`${u}/api/supply`).then(o=>{if(!o.ok)throw new Error("Error al obtener los productos");return o.json()}).then(o=>{i.innerHTML='<option value="">Selecciona un insumo</option>',o.forEach(e=>{const t=document.createElement("option");t.value=e.id,t.textContent=e.name,i.appendChild(t)})}).catch(o=>{console.error("Error al cargar los productos:",o),i.innerHTML='<option value="">Error al cargar los insumos</option>'})};window.onload=function(){$(),B()};let r=0;const v=async()=>{const o=c.value,e=document.getElementById(`insumo-select-${r}`),t=document.getElementById(`insumo-cantidad-${r}`);if(!o||o==="")return alert("Por favor, selecciona un producto."),!1;const a=e.value,l=parseFloat(t.value);if(!a||a===""||isNaN(l)||l<=0)return alert("Por favor, completa el insumo y la cantidad actual."),!1;try{return await w.addFormula({product_id:parseInt(o),supply_id:parseInt(a),quantity:l}),!0}catch(g){return console.error("Error al guardar el insumo:",g),alert("Error al guardar el insumo. Por favor, intenta de nuevo."),!1}},C=()=>{r++;const o=document.createElement("div");o.classList.add("flex","items-end","gap-4","insumo-group"),o.innerHTML=`
        <div class="flex-1 space-y-2">
            <label class="text-sm font-medium leading-none" for="insumo-select-${r}">Insumo</label>
            <select id="insumo-select-${r}" class="form-select flex w-full h-12 rounded-md border border-[var(--border-color)] bg-transparent px-4 py-2 text-sm focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-[var(--button-color)]">
                <option value="">Selecciona un insumo</option>
                <option value="1">Agua</option>
                <option value="2">Hipoclorito</option>
            </select>
        </div>
        <div class="flex-none w-24 space-y-2">
            <label class="text-sm font-medium leading-none" for="insumo-cantidad-${r}">Cantidad</label>
            <input id="insumo-cantidad-${r}" class="form-input flex w-full h-12 rounded-md border border-[var(--border-color)] bg-transparent px-4 py-2 text-sm placeholder:text-[var(--text-secondary)] focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-[var(--button-color)]" placeholder="Litros" type="number"/>
        </div>
    `,F.appendChild(o)};I.addEventListener("click",async()=>{await v()&&(console.log(`Insumo #${r+1} guardado con éxito.`),C())});p.addEventListener("submit",async o=>{o.preventDefault(),await v()&&(console.log("Último insumo guardado con éxito. ¡Fórmula completa!"),alert("¡Fórmula registrada con éxito!"),p.reset(),r=0)});
